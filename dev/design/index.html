<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Design · OhMyArtifacts.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link rel="canonical" href="https://chengchingwen.github.io/OhMyArtifacts.jl/design/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">OhMyArtifacts.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li class="is-active"><a class="tocitem" href>Design</a><ul class="internal"><li><a class="tocitem" href="#Comparison-to-builtin-Artifact-system-(Artifacts.jl)"><span>Comparison to builtin Artifact system (Artifacts.jl)</span></a></li><li><a class="tocitem" href="#Comparison-to-Scratch-Space-API-(Scratch.jl)"><span>Comparison to Scratch Space API (Scratch.jl)</span></a></li><li><a class="tocitem" href="#How-(v0.3)"><span>How (v0.3)</span></a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Design</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Design</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/chengchingwen/OhMyArtifacts.jl/blob/master/docs/src/design.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Design"><a class="docs-heading-anchor" href="#Design">Design</a><a id="Design-1"></a><a class="docs-heading-anchor-permalink" href="#Design" title="Permalink"></a></h1><p>The goal of OhMyArtifacts is to provide a caching api that entries can be added/removed during runtime.  The cache is read-only and shared accross packages, that means there won&#39;t be any duplicated cache if  they are all using OhMyArtifacts. The cache should also track the usage, so when no package is using that  cache, it will be recycled automatically. The ownership of each cache should be able to delegate to the  downstream package, so that when that package is removed, the cache can be freed.</p><h2 id="Comparison-to-builtin-Artifact-system-(Artifacts.jl)"><a class="docs-heading-anchor" href="#Comparison-to-builtin-Artifact-system-(Artifacts.jl)">Comparison to builtin Artifact system (Artifacts.jl)</a><a id="Comparison-to-builtin-Artifact-system-(Artifacts.jl)-1"></a><a class="docs-heading-anchor-permalink" href="#Comparison-to-builtin-Artifact-system-(Artifacts.jl)" title="Permalink"></a></h2><p>We already have a stdlib Artifacts.jl in Julia, Why would you need another one? The main reason is,  the builtin artifacts system requires all artifacts to be known before runtime. The Artifact.toml is placed  at the folder of that package, but since the package folder is read-only now, you cannot modify the  Artifact.toml when you use the package. On the other hand, the cache of Artifacts.jl is based on directory  tree hash, so even if there are multiple duplicate files in different diectory, they cannot share the cache.</p><h2 id="Comparison-to-Scratch-Space-API-(Scratch.jl)"><a class="docs-heading-anchor" href="#Comparison-to-Scratch-Space-API-(Scratch.jl)">Comparison to Scratch Space API (Scratch.jl)</a><a id="Comparison-to-Scratch-Space-API-(Scratch.jl)-1"></a><a class="docs-heading-anchor-permalink" href="#Comparison-to-Scratch-Space-API-(Scratch.jl)" title="Permalink"></a></h2><p>We are actually building on top of Scratch.jl. Scratch.jl provide a set of api for creating package-specific  folder to store any kind of runtime data. In the Scratch.jl README, they also mention that you can  <a href="https://github.com/JuliaPackaging/Scratch.jl#can-i-use-a-scratch-space-as-a-temporary-workspace-then-turn-it-into-an-artifact">turn the scratch space into artifact</a>. So precisely OhMyArtifacts is an implementation of that idea,  but with some modification to the artifact caching behavior. Notice that our implementation is parallel to  the builtin artifact system (Artifacts.jl), so generally it won&#39;t affect each other.</p><h2 id="How-(v0.3)"><a class="docs-heading-anchor" href="#How-(v0.3)">How (v0.3)</a><a id="How-(v0.3)-1"></a><a class="docs-heading-anchor-permalink" href="#How-(v0.3)" title="Permalink"></a></h2><p>We mentioned a few features and issues that we want to solve, but how does it work? General speaking,  we place all the artifacts in the scratch space of OhMyArtifacts. The directory  structure would look like this:</p><pre><code class="nohighlight hljs">OhMyArtifacts-scratchspace/
  |- logs/
    |- my_artifact_usage.toml
    |- my_artifact_orphanages.toml
  |- artifacts/
	|_ &lt;1-byte-prefix&gt;/
	  |- &lt;some sha256 string&gt; (either file or directory)
	...
  |- Package-A-scratchspace/
	|- Artifacts.toml
  |- Package-B-scratchspace/
  |- ...
  ...</code></pre><ol><li>The <code>artifacts</code> folder contains all the cache. Each cache is a read-only file or directory whose name is its</li></ol><p>content (or tree) sha256 hash. The cache is sorted and put in a directory with the name of it&#39;s first byte.  For example, a sha256 string &quot;0102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f20&quot;  would be put in <code>artifacts/01/</code>.</p><ol><li><code>my_artifact_usage.toml</code> is a log file, which track all the usage of each cache. Can be seemed as</li></ol><p>a dictionary mapping from cache to a list of <code>Artifacts.toml</code> that use that cache. We use this to know  whether a cache can be recycled without causing problems.</p><ol><li><code>my_artifact_orphanages.toml</code> is a log file, which track the time that we find a cache is not used</li></ol><p>by any Artifacts.toml any more. So when the recycle mechanism happened, it will check whether the cache  is not used for a given period of time, then recycle it if it exceeds the range.</p><ol><li>For each package that use OhMyArtifacts, we create another scratch space for it in our scratch space.</li></ol><p>When the package is removed, this scratch space might also be recycled, so we would know that the  usage/orphanages toml will need to be updated. This depends on the recycle mechanism of Scratch.jl.</p><ol><li>The <code>Artifacts.toml</code> in the scratchspace is the entry point of the OhMyArtifacts api. When caching</li></ol><p>a file, the api would create a mapping in the Artifacts.toml which map from a name to a sha256 hash.  So when loading the file, the path is just the path of <code>artifacts</code> folder with the a prefix and the hash.</p><ol><li><code>Artifacts.toml</code> has two kinds of entry, <code>isdir = true</code> and <code>isdir = false</code>. When <code>isdir = true</code>, the sha256 hash</li></ol><p>is the tree hash of the entire directory. The directory structure is copied in <code>artifacts</code> with the   tree hash as folder name. For every file in the folder, the usage is recorded and marked by that folder entry,  so whenever the binding of that folder is removed, the usage for every file can be correctly updated.   Every non-folder file in copied folder is a symbolic link points to the real file cache in <code>artifacts</code>.  The tree hash is computed on the original folder, not the copied folder (because copied folder only contains  symbolic links).</p><h3 id="Internal-(v0.3)"><a class="docs-heading-anchor" href="#Internal-(v0.3)">Internal (v0.3)</a><a id="Internal-(v0.3)-1"></a><a class="docs-heading-anchor-permalink" href="#Internal-(v0.3)" title="Permalink"></a></h3><p>Most of the behaviors are documented in the comment of source code.</p><h4 id="Files"><a class="docs-heading-anchor" href="#Files">Files</a><a id="Files-1"></a><a class="docs-heading-anchor-permalink" href="#Files" title="Permalink"></a></h4><ul><li><code>Artifacts.toml</code>: Dict{BindingName =&gt; SHA256ContentHash}</li><li><code>my_artifact_usage.toml</code>: Dict{CachePath =&gt; Dict{ArtifactTomlPath =&gt; Dict{BindingName =&gt; UsageTime}}}</li><li><code>my_artifact_orphanages.toml</code>: Dict{OrphanCachePath =&gt; FoundTime}</li></ul></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Home</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.10 on <span class="colophon-date" title="Sunday 19 June 2022 14:55">Sunday 19 June 2022</span>. Using Julia version 1.7.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
